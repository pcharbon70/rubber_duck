# Feature: Workflow and Legacy Agents Migration (16.4.2)

## Summary
Migrate the RetrievalAgent and WorkflowAgent from legacy architecture to full Jido compliance, implementing action-based patterns for retrieval algorithms and workflow execution.

## Requirements
- [ ] Create RetrievalAgent with Jido.Agent compliance
- [ ] Extract retrieval algorithms into Jido Actions (semantic, hybrid, contextual, multi-hop)
- [ ] Implement result ranking and filtering through Actions
- [ ] Add caching and optimization Actions for retrieval
- [ ] Create WorkflowAgent with proper action-based architecture
- [ ] Extract workflow execution into Jido Actions
- [ ] Implement step coordination through Actions
- [ ] Add progress tracking and recovery Actions
- [ ] Create workflow composition Actions
- [ ] Both agents must follow established error handling patterns
- [ ] Complete test coverage for all Actions and agents
- [ ] Full integration with existing RAG pipeline and workflow systems

## Research Summary

### Existing Usage Rules Checked
- **Jido**: Core patterns for Actions (pure functions, tagged tuples, schemas), Agents (OTP integration, state validation), error handling patterns
- **Ash**: Database operations through Ash framework only
- **ErrorHandling**: Use established ErrorHandling.safe_execute patterns from previous implementations

### Documentation Reviewed
- **Jido.Agent**: OTP-based agent management with lifecycle hooks, state schemas, action composition
- **Jido.Action**: Pure function building blocks with parameter validation and tagged tuple returns
- **Existing Patterns**: ErrorHandling module, ActionErrorPatterns for reusable error patterns

### Existing Patterns Found
- **RAG.Retrieval**: `/home/ducky/code/rubber_duck/lib/rubber_duck/rag/retrieval.ex` - Complete retrieval logic that needs to be extracted into Actions
- **Workflows.Workflow**: `/home/ducky/code/rubber_duck/lib/rubber_duck/workflows/workflow.ex` - Ash resource for workflow persistence
- **WorkflowBehavior**: `/home/ducky/code/rubber_duck/lib/rubber_duck/workflows/workflow_behavior.ex` - Legacy workflow patterns
- **BaseAgent Pattern**: Multiple compliant agents using `RubberDuck.Agents.BaseAgent` with proper action registration
- **ErrorHandling Patterns**: Comprehensive error handling established in QualityImprovementAgent, ShortTermMemoryAgent, PromptManagerAgent

### Technical Approach

#### RetrievalAgent Implementation
1. **Agent Structure**: Use `RubberDuck.Agents.BaseAgent` with proper schema for caching, result history, and configuration
2. **Action Extraction**: 
   - `SemanticRetrievalAction` - Vector embedding-based retrieval
   - `HybridRetrievalAction` - Combined semantic + keyword search  
   - `ContextualRetrievalAction` - Context-aware retrieval
   - `MultiHopRetrievalAction` - Iterative retrieval expansion
   - `RankResultsAction` - Result ranking and filtering
   - `CacheResultsAction` - Result caching and optimization
3. **Integration**: Connect with existing VectorStore and Embeddings services
4. **Error Handling**: Use ErrorHandling.safe_execute patterns throughout

#### WorkflowAgent Implementation
1. **Agent Structure**: Use `RubberDuck.Agents.BaseAgent` with schema for workflow state, progress tracking, step history
2. **Action Extraction**:
   - `ExecuteWorkflowStepAction` - Execute individual workflow steps
   - `CoordinateStepsAction` - Coordinate step execution and dependencies
   - `TrackProgressAction` - Track workflow progress and metrics
   - `RecoverWorkflowAction` - Handle workflow failures and recovery
   - `ComposeWorkflowAction` - Create and compose workflow definitions
   - `ValidateWorkflowAction` - Validate workflow structure and dependencies
3. **Integration**: Connect with existing Workflows domain and Reactor integration
4. **Persistence**: Use existing Workflow Ash resource for state persistence

Both agents will follow the established patterns from successfully migrated agents (QualityImprovementAgent, ShortTermMemoryAgent, PromptManagerAgent) with comprehensive error handling and validation.

## Risks & Mitigations
| Risk | Impact | Mitigation |
|------|--------|------------|
| Breaking existing RAG pipeline | High | Maintain existing RubberDuck.RAG.Retrieval module as wrapper during transition |
| Workflow execution disruption | High | Implement gradual migration with backward compatibility |
| Performance regression in retrieval | Medium | Benchmark against existing implementation, optimize Action composition |
| Complex error handling in workflows | Medium | Use established ErrorHandling patterns and comprehensive testing |
| Integration with existing vector stores | Medium | Preserve existing VectorStore interfaces, add Action wrappers |

## Implementation Checklist
- [ ] Create RetrievalAgent module with BaseAgent foundation
- [ ] Extract SemanticRetrievalAction from existing retrieval.ex logic
- [ ] Extract HybridRetrievalAction with parallel execution patterns
- [ ] Extract ContextualRetrievalAction with context enhancement
- [ ] Extract MultiHopRetrievalAction with iterative expansion
- [ ] Create RankResultsAction and CacheResultsAction
- [ ] Create WorkflowAgent module with BaseAgent foundation  
- [ ] Extract ExecuteWorkflowStepAction and CoordinateStepsAction
- [ ] Extract TrackProgressAction and RecoverWorkflowAction
- [ ] Extract ComposeWorkflowAction and ValidateWorkflowAction
- [ ] Add comprehensive error handling to all Actions
- [ ] Create integration tests for both agents
- [ ] Verify RAG pipeline integration works correctly
- [ ] Verify workflow execution maintains existing functionality
- [ ] Performance benchmark against existing implementations
- [ ] Update planning document to mark section 16.4.2 as completed

## Questions for Pascal
None at this time - implementation approach is clear based on established patterns.